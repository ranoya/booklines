<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://booklines.vercel.app/docs/struct.css"
    />
  </head>

  <body></body>

  <script>
    let goto = function (who) {
      document.getElementById(who).scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    };
  </script>

  <script>
    let insereSumarion = document.createElement("div");
    insereSumarion.id = "sumarion";
    document.body.appendChild(insereSumarion);

    let insereTituloVisual = document.createElement("div");
    insereTituloVisual.id = "visualtitle";
    document.body.appendChild(insereTituloVisual);
  </script>

  <script>
    let trocatudo = function (els) {
      for (let i = 0; i < els.length; i++) {
        console.log(i + "/" + els.length + " ... " + els[i]);
        if (els[i].innerHTML.match(/\@&gt; /gi)) {
          let conteudo = els[i].innerHTML.replace(/\@&gt; /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("ref");
        }

        if (els[i].innerHTML.match(/\@\&lt\; /gi)) {
          let conteudo = els[i].innerHTML.replace(/\@\&lt\; /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("outline");
        }

        if (els[i].innerHTML.match(/\!\&gt\;\d{1,3} /gi)) {
          let quanti = parseInt(els[i].innerHTML.match(/\d{1,3}/gi));
          let conteudo = els[i].innerHTML.replace(/\!\&gt\;\d{1,3} /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("ref");
          els[i].style.gridRow = "span " + quanti;
          els[i].firstElementChild.classList.add("fix");
        }

        if (els[i].innerHTML.match(/\!\&lt\;\d{1,3} /gi)) {
          let quanti = parseInt(els[i].innerHTML.match(/\d{1,3}/gi));
          let conteudo = els[i].innerHTML.replace(/\!\&lt\;\d{1,3} /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("outline");
          els[i].style.gridRow = "span " + quanti;
          els[i].firstElementChild.classList.add("fix");
        }

        if (els[i].innerHTML.match(/\%&gt; /gi)) {
          let conteudo = els[i].innerHTML.replace(/\%&gt; /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("halfRight");
        }

        if (els[i].innerHTML.match(/\%\&lt\; /gi)) {
          let conteudo = els[i].innerHTML.replace(/\%\&lt\; /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("halfLeft");
        }

        if (els[i].innerHTML.match(/\!\%\&gt\;\d{1,3} /gi)) {
          let quanti = parseInt(els[i].innerHTML.match(/\d{1,3}/gi));
          let conteudo = els[i].innerHTML.replace(/\!\%\&gt\;\d{1,3} /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("halfRight");
          els[i].style.gridRow = "span " + quanti;
          els[i].firstElementChild.classList.add("fix");
        }

        if (els[i].innerHTML.match(/\!\%\&lt\;\d{1,3} /gi)) {
          let quanti = parseInt(els[i].innerHTML.match(/\d{1,3}/gi));
          let conteudo = els[i].innerHTML.replace(/\!\%\&lt\;\d{1,3} /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("halfLeft");
          els[i].style.gridRow = "span " + quanti;
          els[i].firstElementChild.classList.add("fix");
        }

        if (els[i].innerHTML.match(/\-\+\- /gi)) {
          let conteudo = els[i].innerHTML.replace(/\-\+\- /gi, "");
          els[i].innerHTML = conteudo;
          els[i].classList.add("fix");

          if (
            els[i].innerHTML.match(/\<h2/i) ||
            els[i].innerHTML.match(/\&lt\;h2/i)
          ) {
            els[i].classList.add("forceH2fix");
          }
        }

        if (els[i].innerHTML.match(/\@\{(.*)\}/)) {
          let palavras = els[i].innerHTML.match(/\@\{(.*)\}/)[1];
          let conteudo = els[i].innerHTML.replace(/\@\{(.*)\}/, "");
          let conteudo2 =
            `<a name="${palavras}" id="${palavras}" class="indexs">${palavras}</a>` +
            conteudo;
          els[i].innerHTML = conteudo2;
        }
      }

      let insereTagTitle = document.createElement("title");
      insereTagTitle.textContent =
        document.getElementsByTagName("h1")[0].innerHTML;
      document.getElementsByTagName("head")[0].appendChild(insereTagTitle);

      document.body.onscroll = function (e) {
        if (
          document.getElementsByTagName("h1")[0].getBoundingClientRect().top <=
          -50
        ) {
          document.getElementById("visualtitle").innerHTML =
            document.getElementsByTagName("h1")[0].innerHTML;
        } else {
          document.getElementById("visualtitle").innerHTML = "";
        }
      };

      let sumarion = document.querySelectorAll("a.indexs");
      let sumarioncode = "";

      if (sumarion.length > 0) {
        for (let i = sumarion.length - 1; i >= 0; i--) {
          sumarioncode += `<div onclick="goto('${sumarion[i].name}')">${sumarion[i].name}</div>`;
        }

        document.getElementById("sumarion").innerHTML = sumarioncode;
      }
    };

    $_GET = [];
    (function () {
      corte = window.location.href.toString().indexOf("?");
      if (corte > 0) {
        argumento = window.location.href.toString().substring(corte + 1);
        argumentos = argumento.split("&");
        for (arg in argumentos) {
          let argCorte = argumentos[arg].indexOf("=");
          $_GET[argumentos[arg].substring(0, argCorte)] = argumentos[
            arg
          ].substring(argCorte + 1);
        }
      }
    })();

    /* 

     HTML & MD

    */

    if (
      typeof $_GET["url"] != "undefined" &&
      $_GET["url"] != null &&
      $_GET["url"] != ""
    ) {
      if ($_GET["url"].match(/\.md$/)) {
        console.log("achou um md");

        let inseremd = document.createElement("script");
        inseremd.src =
          "https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js";
        document.getElementsByTagName("head")[0].appendChild(inseremd);

        fetch($_GET["url"])
          .then((response) => {
            return response.text();
          })
          .then((dados) => {
            let mdconverter = new showdown.Converter();
            mdconverter.setOption("tables", "true");
            mdconverter.setOption("simpleLineBreaks", "true");
            let dadosmd = mdconverter.makeHtml(dados);

            document.body.innerHTML = dadosmd;

            let insiste = setInterval(function () {
              if (document.body.innerHTML != "") {
                console.log(document.body.innerHTML);
                console.log(document.body.children);

                clearInterval(insiste);

                let els = document.body.children;

                trocatudo(els);
              }
            }, 10);
          });
      }
      //
      if ($_GET["url"].match(/\.html$/)) {
        console.log("achou um html");

        fetch($_GET["url"])
          .then((response) => {
            return response.text();
          })
          .then((dados) => {
            document.body.innerHTML = dados;

            let insiste = setInterval(function () {
              if (document.body.innerHTML != "") {
                console.log(document.body.innerHTML);
                console.log(document.body.children);

                clearInterval(insiste);

                let els = document.body.children;

                trocatudo(els);
              }
            }, 10);
          });
      }
    }

    /* 

     OBSERVABLE 

    */

    if (
      typeof $_GET["notebook"] != "undefined" &&
      $_GET["notebook"] != null &&
      $_GET["notebook"] != ""
    ) {
      const autopub = document.createElement("script");
      autopub.setAttribute("type", "module");
      const elautopub = document.createTextNode(
        `
    
    import {
    Runtime,
    Inspector,
  } from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@5/dist/runtime.js";
  import define from "https://api.observablehq.com/${$_GET["notebook"]}.js?v=4";
  new Runtime().module(define, Inspector.into("body"));   
    `,
      );
      autopub.appendChild(elautopub);
      document.getElementsByTagName("body")[0].appendChild(autopub);

      let insiste = setInterval(function () {
        if (
          document.body.innerHTML.match(/observablehq/) &&
          !document.body.innerHTML.match(/observablehq\-\-running/gi)
        ) {
          clearInterval(insiste);
          setTimeout(function () {
            let els = document.getElementsByClassName("observablehq");

            trocatudo(els);
          }, 1500);
        }
      }, 10);
    }
  </script>
</html>
